@typeparam TItem
@using Microsoft.FluentUI.AspNetCore.Components
@using FluentUI.Components.UI.Tables.Models
@inject IMessageService MessageService

@implements IDialogContentComponent<List<TableColumn<TItem>>>

<FluentDialogHeader>
	<FluentLabel Typo="Typography.H3">edit Columns</FluentLabel>
</FluentDialogHeader>

<FluentDialogBody>
	<FluentMessageBarProvider Section="MESSAGES_COLUMNEDIT" Format="MessageFormat.Notification" />
	
	@if (Content != null)
	{
		<FluentSortableList Items="Content" OnUpdate="@SortList">
			<ItemTemplate>
				@{
					var column = context;
					var isLastVisible = Content.Count(c => c.IsVisible) == 1 && column.IsVisible;
					var opacity = isLastVisible ? "0.5" : "1";
					var cursor = isLastVisible ? "not-allowed" : "pointer";
				}
				<div class="sortable-grab">
					<FluentIcon Value="@(new Icons.Regular.Size20.ArrowSort())" />
				</div>
				<div class="sortable-item-content" style="flex-grow: 1;">
					<FluentStack Orientation="FluentOrientation.Horizontal"
								 VerticalAlignment="VerticalAlignment.Center"
								 Style="@($"padding: 8px; border-radius: 4px; opacity: {opacity}; gap: 4px;")">
                    
						@* Visibility toggle *@
						<FluentStack Orientation="FluentOrientation.Horizontal"
									 VerticalAlignment="VerticalAlignment.Center"
									 Style="@($"cursor: {cursor}; flex: 1; justify-content: space-between;")"
									 @onclick="@(() => ToggleColumn(column))">
							<FluentLabel>@column.Title</FluentLabel>
							@if (column.IsVisible)
							{
								<FluentIcon Value="@(new Icons.Regular.Size20.Eye())" Color="FluentColor.Accent" />
							}
							else
							{
								<FluentIcon Value="@(new Icons.Regular.Size20.EyeOff())" Color="FluentColor.Neutral" />
							}
						</FluentStack>
					</FluentStack>
				</div>
				
			</ItemTemplate>
		</FluentSortableList>
	}
</FluentDialogBody>

<FluentDialogFooter>
	<FluentButton Appearance="Appearance.Accent" OnClick="@SaveAsync">Save</FluentButton>
	<FluentButton Appearance="Appearance.Neutral" OnClick="@ResetAsync">Reset</FluentButton>
</FluentDialogFooter>

@code {
	[Parameter]
	public List<TableColumn<TItem>> Content { get; set; } = new();

	[CascadingParameter]
	public FluentDialog? Dialog { get; set; }

	private List<(TableColumn<TItem> Column, bool IsVisible, int OriginalIndex)>? _previousState;

	protected override void OnInitialized()
	{
		// Store original state for reset functionality
		if (Content != null)
		{
			_previousState = Content.Select((col, index) => (col, col.IsVisible, index)).ToList();
		}
	}

	private void SortList(FluentSortableListEventArgs args)
	{
		if (args is null || args.OldIndex == args.NewIndex)
		{
			return;
		}

		var oldIndex = args.OldIndex;
		var newIndex = args.NewIndex;

		var items = this.Content;
		var itemToMove = items[oldIndex];
		items.RemoveAt(oldIndex);

		if (newIndex < items.Count)
		{
			items.Insert(newIndex, itemToMove);
		}
		else
		{
			items.Add(itemToMove);
		}

		//Resets the order of all items to match the new order in the list
		foreach (var item in items)
		{
			item.SortOrder = items.IndexOf(item);
		}
	}

	private void ToggleColumn(TableColumn<TItem> column)
	{
		// Prevent hiding the last visible column
		if (Content != null && Content.Count(c => c.IsVisible) == 1 && column.IsVisible)
		{
			return;
		}

		column.IsVisible = !column.IsVisible;
	}

	private async Task SaveAsync()
	{
		await Dialog!.CloseAsync(Content);
	}

	private async Task ResetAsync()
	{
		if (Content != null && _previousState != null)
		{
			// Restore visibility
			foreach (var state in _previousState)
			{
				state.Column.IsVisible = state.IsVisible;
			}

			// Restore original order
			Content.Clear();
			foreach (var state in _previousState.OrderBy(s => s.OriginalIndex))
			{
				Content.Add(state.Column);
			}
			MessageService.Clear("MESSAGES_COLUMNEDIT");
			// Show success message
			MessageService.ShowMessageBar(options =>
					{
						options.Intent = MessageIntent.Error;
						options.Title = "Validation error";
						options.Body = "Must have at least 1 column visible.";
						options.Timestamp = DateTime.Now;
						options.Section = "MESSAGES_COLUMNEDIT";
					});
			StateHasChanged();
		}
        
		// await Dialog!.CloseAsync();
	}
}
